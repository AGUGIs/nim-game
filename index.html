<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üîÆ –•—Ä–æ–Ω–∏–∫–∏ –ö—Ä–∏—Å—Ç–∞–ª–ª–æ–≤: –ë–∏—Ç–≤–∞ –ú–∞–≥–æ–≤</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Almendra+Display&display=swap" rel="stylesheet">
  <style>
    /* ====== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –¢–ï–ú ====== */
    :root {
      --bg: #0c0b1f;
      --fg: #e0e0ff;
      --accent: #b967ff;
      --gold: #ffd700;
      --crystal: #00f7ff;
      --shadow: 0 0 20px rgba(185, 103, 255, 0.5);
    }

    [data-theme="light"] {
      --bg: #f9f5eb;
      --fg: #2c1e3c;
      --accent: #6a5acd;
      --gold: #d4af37;
      --crystal: #4b0082;
      --shadow: 0 0 15px rgba(106, 90, 205, 0.4);
    }

    [data-theme="rainbow"] {
      --bg: #000;
      background: linear-gradient(135deg, #ff00cc, #3333ff, #00ccff, #00ffcc, #ccff00, #ff9900) !important;
      animation: bgRainbow 20s infinite linear;
    }

    @keyframes bgRainbow {
      0% { background-position: 0% 50%; }
      100% { background-position: 100% 50%; }
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background-color: var(--bg);
      color: var(--fg);
      font-family: 'Cinzel', serif;
      min-height: 100vh;
      padding: 15px;
      overflow-x: hidden;
      position: relative;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      background: 
        radial-gradient(circle at 20% 30%, rgba(185, 103, 255, 0.05) 0%, transparent 40%),
        radial-gradient(circle at 80% 70%, rgba(0, 247, 255, 0.05) 0%, transparent 40%);
      z-index: -1;
    }

    .stars {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      z-index: -2;
    }

    .star {
      position: absolute;
      background: white;
      border-radius: 50%;
      animation: twinkle var(--dur) infinite ease-in-out;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.2; }
      50% { opacity: 1; }
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      position: relative;
    }

    h1 {
      text-align: center;
      font-size: 2.8rem;
      margin: 20px 0;
      text-shadow: 0 0 15px var(--accent);
      background: linear-gradient(to right, var(--gold), var(--crystal), var(--gold));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      font-weight: 900;
      letter-spacing: 2px;
    }

    .panel {
      background: rgba(20, 15, 40, 0.7);
      backdrop-filter: blur(12px);
      border: 2px solid var(--accent);
      border-radius: 24px;
      padding: 25px;
      margin: 20px 0;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    [data-theme="light"] .panel {
      background: rgba(255, 250, 240, 0.85);
      border-color: var(--accent);
    }

    .panel::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; height: 4px;
      background: linear-gradient(90deg, transparent, var(--gold), var(--crystal), var(--gold), transparent);
    }

    .section-title {
      font-family: 'Almendra Display', cursive;
      font-size: 2rem;
      text-align: center;
      margin-bottom: 20px;
      color: var(--gold);
    }

    /* SETUP */
    .setup-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .setup-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    label {
      margin-bottom: 8px;
      font-size: 1.1rem;
      color: #ccc;
    }

    input, select, button {
      background: rgba(30, 20, 60, 0.8);
      border: 1px solid var(--accent);
      color: white;
      padding: 10px 15px;
      border-radius: 12px;
      font-size: 1.1rem;
      outline: none;
      width: 100%;
      text-align: center;
    }

    [data-theme="light"] input,
    [data-theme="light"] select,
    [data-theme="light"] button {
      background: white;
      color: var(--fg);
    }

    button {
      background: linear-gradient(135deg, #8a2be2, #00bfff);
      border: none;
      color: white;
      font-weight: bold;
      cursor: pointer;
      letter-spacing: 1px;
      position: relative;
      overflow: hidden;
      transition: transform 0.2s;
    }

    button:hover {
      transform: scale(1.03);
      box-shadow: 0 0 20px rgba(138, 43, 226, 0.7);
    }

    /* HEAPS */
    .heaps-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 25px;
      margin: 25px 0;
    }

    .heap {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .flask {
      position: relative;
      width: 90px;
      height: 140px;
      background: rgba(10, 5, 30, 0.6);
      border: 3px solid var(--gold);
      border-radius: 0 0 45px 45px;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: center;
      padding-bottom: 15px;
      animation: breathe 6s infinite ease-in-out;
    }

    [data-theme="light"] .flask {
      background: rgba(255, 250, 240, 0.9);
      border-color: var(--gold);
    }

    @keyframes breathe {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }

    .flask::before {
      content: '';
      position: absolute;
      top: -25px;
      width: 45px;
      height: 22px;
      background: var(--gold);
      border-radius: 50%;
    }

    .crystals {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      height: 100px;
      overflow: hidden;
    }

    .crystal {
      font-size: 26px;
      opacity: 0;
      animation: appear 0.4s forwards;
    }

    @keyframes appear {
      to { opacity: 1; transform: translateY(0); }
    }

    .heap-label {
      margin-top: 12px;
      font-size: 1.2rem;
      color: var(--gold);
    }

    /* CONTROLS */
    .controls-row {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
      margin: 20px 0;
    }

    #message {
      text-align: center;
      min-height: 32px;
      margin: 20px 0;
      font-size: 1.4rem;
      font-weight: bold;
      color: #ff6b9d;
      text-shadow: 0 0 10px rgba(255, 107, 157, 0.6);
    }

    #turnDisplay {
      text-align: center;
      font-size: 2rem;
      margin: 15px 0;
      color: var(--gold);
      text-shadow: 0 0 12px rgba(255, 215, 0, 0.8);
    }

    .hidden { display: none !important; }

    /* STATS */
    .stats {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
      font-size: 1rem;
      color: #aaa;
    }

    /* PARTICLES */
    .particles {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      z-index: 100;
    }

    .particle {
      position: absolute;
      font-size: 20px;
      opacity: 0;
      pointer-events: none;
    }

    /* SETTINGS */
    .settings-bar {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .theme-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid white;
    }

    #dark-theme { background: #0c0b1f; }
    #light-theme { background: #f9f5eb; }
    #rainbow-theme { background: linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet); }

    .win-effect {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      z-index: 200;
      opacity: 0;
    }
  </style>
</head>
<body>
  <div class="stars" id="stars"></div>
  <div class="particles" id="particles"></div>
  <div class="win-effect" id="winEffect"></div>

  <div class="container">
    <h1>üîÆ –•—Ä–æ–Ω–∏–∫–∏ –ö—Ä–∏—Å—Ç–∞–ª–ª–æ–≤: –ë–∏—Ç–≤–∞ –ú–∞–≥–æ–≤</h1>

    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–º—ã –∏ –∑–≤—É–∫–∞ -->
    <div class="settings-bar">
      <div title="–¢—ë–º–Ω–∞—è –º–∞–≥–∏—è">
        <div class="theme-btn" id="dark-theme" onclick="setTheme('dark')"></div>
      </div>
      <div title="–°–≤–µ—Ç–ª–∞—è –∞–ª—Ö–∏–º–∏—è">
        <div class="theme-btn" id="light-theme" onclick="setTheme('light')"></div>
      </div>
      <div title="–†–∞–¥—É–∂–Ω–∞—è –∞—Ä–∫–∞–Ω–∞">
        <div class="theme-btn" id="rainbow-theme" onclick="setTheme('rainbow')"></div>
      </div>
      <button id="soundToggle" onclick="toggleSound()">üîä –ó–≤—É–∫: –í–∫–ª</button>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="panel">
      <div class="stats">
        <div>–ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ: <span id="gamesPlayed">0</span></div>
        <div>–ü–æ–±–µ–¥ –ò–≥—Ä–æ–∫ 1: <span id="winsP1">0</span></div>
        <div>–ü–æ–±–µ–¥ –ò–≥—Ä–æ–∫ 2 / –ò–ò: <span id="winsP2">0</span></div>
      </div>
    </div>

    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ -->
    <div id="setup" class="panel">
      <div class="section-title">–°–æ–∑–¥–∞–Ω–∏–µ –º–∞–≥–∏—á–µ—Å–∫–æ–≥–æ –∫—Ä—É–≥–∞</div>
      <div class="setup-grid">
        <div class="setup-item">
          <label>–†–µ–∂–∏–º:</label>
          <select id="gameMode">
            <option value="pvp">2 –ú–∞–≥–∞</option>
            <option value="ai">–ü—Ä–æ—Ç–∏–≤ –ò–ò</option>
          </select>
        </div>
        <div class="setup-item">
          <label>–°–ª–æ–∂–Ω–æ—Å—Ç—å –ò–ò:</label>
          <select id="aiLevel">
            <option value="easy">–£—á–µ–Ω–∏–∫</option>
            <option value="medium" selected>–ú–∞–≥</option>
            <option value="hard">–ê—Ä—Ö–∏–º–∞–≥</option>
          </select>
        </div>
        <div class="setup-item">
          <label>–ö–æ–ª–±—ã (1‚Äì10):</label>
          <input type="number" id="numHeaps" min="1" max="10" value="4">
        </div>
        <div id="heapInputs"></div>
      </div>
      <div style="text-align: center;">
        <button onclick="setupHeaps()">–ù–∞—á–∞—Ç—å —Ä–∏—Ç—É–∞–ª</button>
      </div>
    </div>

    <!-- –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ -->
    <div id="game" class="panel hidden">
      <div class="section-title">–ë–∏—Ç–≤–∞ –º–∞–≥–æ–≤</div>
      <div id="turnDisplay">–•–æ–¥ –º–∞–≥–∞ 1</div>
      <div class="heaps-container" id="heapsDisplay"></div>
      <div id="message"></div>

      <div id="moveControls" class="controls-row hidden">
        <div>
          <label>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–±—É:</label>
          <select id="heapSelect"></select>
        </div>
        <div>
          <label>–ö—Ä–∏—Å—Ç–∞–ª–ª—ã (1‚Äì3):</label>
          <select id="takeSelect">
            <option>1</option><option>2</option><option>3</option>
          </select>
        </div>
        <div style="align-self: flex-end;">
          <button onclick="makeMove()">–ò–∑–≤–ª–µ—á—å</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ======
    let heaps = [];
    let currentPlayer = 1;
    let gameMode = 'pvp'; // 'pvp' –∏–ª–∏ 'ai'
    let aiLevel = 'medium';
    let stats = {
      games: 0,
      winsP1: 0,
      winsP2: 0
    };
    let soundEnabled = true;
    let gameActive = false;

    // ====== –ê–£–î–ò–û (Base64) ======
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    function playTone(freq, dur = 0.2) {
      if (!soundEnabled) return;
      const osc = audioContext.createOscillator();
      const gain = audioContext.createGain();
      osc.connect(gain);
      gain.connect(audioContext.destination);
      osc.frequency.value = freq;
      gain.gain.value = 0.1;
      osc.start();
      gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + dur);
      osc.stop(audioContext.currentTime + dur);
    }

    function playCrystalSound() { playTone(880, 0.15); }
    function playWinSound() {
      [523, 659, 784, 1046].forEach((f, i) => setTimeout(() => playTone(f, 0.3), i * 200));
    }

    // ====== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ======
    function initStars() {
      const stars = document.getElementById('stars');
      for (let i = 0; i < 150; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.left = `${Math.random() * 100}%`;
        star.style.top = `${Math.random() * 100}%`;
        star.style.width = `${Math.random() * 3}px`;
        star.style.height = star.style.width;
        star.style.setProperty('--dur', `${2 + Math.random() * 5}s`);
        stars.appendChild(star);
      }
    }

    // ====== –¢–ï–ú–´ ======
    function setTheme(theme) {
      document.body.setAttribute('data-theme', theme === 'rainbow' ? 'rainbow' : '');
      if (theme !== 'rainbow') {
        document.body.style.background = '';
      }
      localStorage.setItem('nim-theme', theme);
    }

    // ====== –ó–í–£–ö ======
    function toggleSound() {
      soundEnabled = !soundEnabled;
      document.getElementById('soundToggle').textContent = soundEnabled ? 'üîä –ó–≤—É–∫: –í–∫–ª' : 'üîá –ó–≤—É–∫: –í—ã–∫–ª';
      localStorage.setItem('nim-sound', soundEnabled);
    }

    // ====== –ù–ê–°–¢–†–û–ô–ö–ê –ò–ì–†–´ ======
    document.getElementById('numHeaps').addEventListener('input', function () {
      const num = Math.min(10, Math.max(1, parseInt(this.value) || 1));
      const container = document.getElementById('heapInputs');
      container.innerHTML = '';
      for (let i = 1; i <= num; i++) {
        const div = document.createElement('div');
        div.className = 'setup-item';
        div.innerHTML = `<label>–ö–æ–ª–±–∞ ${i}:</label><input type="number" id="heap${i}" min="1" max="20" value="5">`;
        container.appendChild(div);
      }
    });

    window.onload = () => {
      initStars();
      document.getElementById('numHeaps').dispatchEvent(new Event('input'));
      const savedTheme = localStorage.getItem('nim-theme') || 'dark';
      const savedSound = localStorage.getItem('nim-sound') !== 'false';
      setTheme(savedTheme);
      soundEnabled = savedSound;
      document.getElementById('soundToggle').textContent = soundEnabled ? 'üîä –ó–≤—É–∫: –í–∫–ª' : 'üîá –ó–≤—É–∫: –í—ã–∫–ª';
      loadStats();
    };

    function loadStats() {
      const saved = localStorage.getItem('nim-stats');
      if (saved) stats = JSON.parse(saved);
      updateStats();
    }

    function saveStats() {
      localStorage.setItem('nim-stats', JSON.stringify(stats));
      updateStats();
    }

    function updateStats() {
      document.getElementById('gamesPlayed').textContent = stats.games;
      document.getElementById('winsP1').textContent = stats.winsP1;
      document.getElementById('winsP2').textContent = stats.winsP2;
    }

    // ====== –ó–ê–ü–£–°–ö –ò–ì–†–´ ======
    function setupHeaps() {
      gameMode = document.getElementById('gameMode').value;
      aiLevel = document.getElementById('aiLevel').value;
      const num = parseInt(document.getElementById('numHeaps').value) || 1;
      heaps = [];
      for (let i = 1; i <= num; i++) {
        const val = parseInt(document.getElementById(`heap${i}`).value) || 1;
        heaps.push(Math.max(1, Math.min(20, val)));
      }

      stats.games++;
      saveStats();

      document.getElementById('setup').classList.add('hidden');
      document.getElementById('game').classList.remove('hidden');
      currentPlayer = 1;
      gameActive = true;
      renderGame();

      if (gameMode === 'ai' && currentPlayer === 2) {
        setTimeout(aiMove, 1000);
      }
    }

    // ====== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï ======
    function renderGame() {
      const display = document.getElementById('heapsDisplay');
      display.innerHTML = '';

      let nonEmpty = false;
      for (let i = 0; i < heaps.length; i++) {
        if (heaps[i] > 0) nonEmpty = true;

        const heapDiv = document.createElement('div');
        heapDiv.className = 'heap';
        const crystalsDiv = document.createElement('div');
        crystalsDiv.className = 'crystals';

        for (let j = 0; j < heaps[i]; j++) {
          const crystal = document.createElement('div');
          crystal.className = 'crystal';
          crystal.textContent = '‚ú¶';
          crystal.style.animationDelay = `${j * 0.05}s`;
          crystalsDiv.appendChild(crystal);
        }

        const flask = document.createElement('div');
        flask.className = 'flask';
        flask.appendChild(crystalsDiv);

        heapDiv.appendChild(flask);
        heapDiv.innerHTML += `<div class="heap-label">–ö–æ–ª–±–∞ ${i + 1}</div>`;
        display.appendChild(heapDiv);
      }

      const playerName = gameMode === 'ai' 
        ? (currentPlayer === 1 ? '–ú–∞–≥' : '–ò–ò') 
        : `–ú–∞–≥ ${currentPlayer}`;
      document.getElementById('turnDisplay').textContent = `–•–æ–¥ ${playerName}`;

      if (nonEmpty) {
        if (gameMode === 'pvp' || currentPlayer === 1) {
          updateMoveControls();
          document.getElementById('moveControls').classList.remove('hidden');
        } else {
          document.getElementById('moveControls').classList.add('hidden');
        }
        document.getElementById('message').textContent = '';
      } else {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        const winner = currentPlayer === 1 ? 2 : 1;
        let message = '';
      
        if (gameMode === 'ai') {
          if (winner === 1) {
            message = 'üåü –í—ã –ø–æ–±–µ–¥–∏–ª–∏! –ú–∞–≥–∏—è ‚Äî –≤ –≤–∞—à–∏—Ö —Ä—É–∫–∞—Ö! üåü';
          } else {
            message = 'üíÄ –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏... –ò–ò —Å–ª–∏—à–∫–æ–º —Å–∏–ª—ë–Ω. üíÄ';
          }
        } else {
          message = `üåü –ú–∞–≥ ${winner} –æ–¥–µ—Ä–∂–∞–ª –ø–æ–±–µ–¥—É! üåü`;
        }
      
        document.getElementById('message').textContent = message;
        
        if (winner === 1) stats.winsP1++; else stats.winsP2++;
        saveStats();

        gameActive = false;
        playWinSound();
        showWinEffect();
        document.getElementById('moveControls').classList.add('hidden');
        setTimeout(() => {
          if (confirm('–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É?')) {
            document.getElementById('game').classList.add('hidden');
            document.getElementById('setup').classList.remove('hidden');
          }
        }, 2000);
      }
    }

    function updateMoveControls() {
      const heapSelect = document.getElementById('heapSelect');
      heapSelect.innerHTML = '';
      for (let i = 0; i < heaps.length; i++) {
        if (heaps[i] > 0) {
          const opt = document.createElement('option');
          opt.value = i;
          opt.textContent = `–ö–æ–ª–±–∞ ${i + 1} (${heaps[i]})`;
          heapSelect.appendChild(opt);
        }
      }
      updateTakeOptions();
    }

    function updateTakeOptions() {
      const heapSelect = document.getElementById('heapSelect');
      const takeSelect = document.getElementById('takeSelect');
      if (heapSelect.options.length === 0) return;

      const idx = parseInt(heapSelect.value);
      const max = Math.min(3, heaps[idx]);
      takeSelect.innerHTML = '';
      for (let t = 1; t <= max; t++) {
        takeSelect.innerHTML += `<option value="${t}">${t}</option>`;
      }
    }

    // ====== –•–û–î –ò–ì–†–û–ö–ê ======
    function makeMove() {
      if (!gameActive) return;
      const heapSelect = document.getElementById('heapSelect');
      const takeSelect = document.getElementById('takeSelect');

      if (heapSelect.options.length === 0) {
        document.getElementById('message').textContent = '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–ª–±!';
        return;
      }

      const heapIdx = parseInt(heapSelect.value);
      const take = parseInt(takeSelect.value);

      if (take < 1 || take > 3 || take > heaps[heapIdx]) {
        document.getElementById('message').textContent = '–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ä–∏—Ç—É–∞–ª!';
        return;
      }

      createParticles(heapIdx, take);
      playCrystalSound();

      heaps[heapIdx] -= take;
      currentPlayer = currentPlayer === 1 ? 2 : 1;

      setTimeout(renderGame, 500);

      if (gameMode === 'ai' && currentPlayer === 2 && gameActive) {
        setTimeout(aiMove, 1200);
      }
    }

    // ====== –ò–ò ======
    function aiMove() {
      if (!gameActive) return;

      let heapIdx = -1, take = 1;

      // –ü—Ä–æ—Å—Ç–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è: –µ—Å–ª–∏ –º–æ–∂–Ω–æ –≤—ã–∏–≥—Ä–∞—Ç—å ‚Äî –≤—ã–∏–≥—Ä–∞—Ç—å, –∏–Ω–∞—á–µ —Å–ª—É—á–∞–π–Ω–æ
      const nonEmpty = heaps.map((h, i) => h > 0 ? i : -1).filter(i => i !== -1);
      if (nonEmpty.length === 0) return;

      // –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ —Ö–æ–¥, –ø–æ—Å–ª–µ –∫–æ—Ç–æ—Ä–æ–≥–æ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è 0 –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤
      for (const i of nonEmpty) {
        if (heaps[i] <= 3) {
          heapIdx = i;
          take = heaps[i];
          break;
        }
      }

      // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ ‚Äî —Å–ª—É—á–∞–π–Ω—ã–π —Ö–æ–¥ (—Å —É–∫–ª–æ–Ω–æ–º –∫ "—É–º–Ω–æ–º—É" –ø–æ–≤–µ–¥–µ–Ω–∏—é –Ω–∞ –≤—ã—Å–æ–∫–æ–º —É—Ä–æ–≤–Ω–µ)
      if (heapIdx === -1) {
        heapIdx = nonEmpty[Math.floor(Math.random() * nonEmpty.length)];
        take = Math.min(3, heaps[heapIdx]);
        if (aiLevel === 'hard') {
          // –ü—ã—Ç–∞–µ–º—Å—è –æ—Å—Ç–∞–≤–∏—Ç—å –∫—Ä–∞—Ç–Ω–æ 4 (–±–∞–∑–æ–≤–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è 1-3 Nim)
          const remainder = heaps[heapIdx] % 4;
          if (remainder !== 0) {
            take = remainder;
          } else {
            take = Math.min(3, heaps[heapIdx]);
          }
        } else if (aiLevel === 'medium') {
          // –ò–Ω–æ–≥–¥–∞ –¥–µ–ª–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ö–æ–¥
          if (Math.random() > 0.4) {
            take = Math.min(3, heaps[heapIdx]);
          }
        }
        // easy ‚Äî –≤—Å–µ–≥–¥–∞ —Å–ª—É—á–∞–π–Ω–æ
      }

      // –ê–Ω–∏–º–∞—Ü–∏—è "—Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–π"
      document.getElementById('message').textContent = 'üîÆ –ò–ò —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–µ–Ω...';
      setTimeout(() => {
        if (!gameActive) return;
        heaps[heapIdx] -= take;
        createParticles(heapIdx, take);
        playCrystalSound();
        currentPlayer = 1;
        renderGame();
        document.getElementById('message').textContent = '';
      }, 800);
    }

    // ====== –≠–§–§–ï–ö–¢–´ ======
    function createParticles(heapIdx, count) {
      const heapEl = document.querySelectorAll('.heap')[heapIdx];
      if (!heapEl) return;
      const rect = heapEl.getBoundingClientRect();
      const x = rect.left + rect.width / 2;
      const y = rect.top + 20;

      for (let i = 0; i < count * 3; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        p.textContent = '‚úß';
        p.style.left = `${x}px`;
        p.style.top = `${y}px`;
        p.style.color = i % 3 === 0 ? '#ff00ff' : i % 3 === 1 ? '#00ffff' : '#ffff00';
        document.getElementById('particles').appendChild(p);

        const angle = Math.random() * Math.PI * 2;
        const speed = 1 + Math.random() * 3;
        const vx = Math.cos(angle) * speed;
        const vy = Math.sin(angle) * speed - 2; // –≤–≤–µ—Ä—Ö

        let opacity = 1;
        let posX = x, posY = y;
        const anim = () => {
          opacity -= 0.02;
          posX += vx;
          posY += vy;
          vy += 0.1; // –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏—è
          p.style.opacity = opacity;
          p.style.transform = `translate(${posX - x}px, ${posY - y}px)`;
          if (opacity > 0) requestAnimationFrame(anim);
          else p.remove();
        };
        requestAnimationFrame(anim);
      }
    }

    function showWinEffect() {
      const effect = document.getElementById('winEffect');
      effect.innerHTML = '';
      effect.style.opacity = '1';
      effect.style.background = 'radial-gradient(circle, rgba(255,215,0,0.8) 0%, rgba(138,43,226,0.6) 100%)';
      setTimeout(() => {
        effect.style.opacity = '0';
      }, 1500);
    }

    // ====== –°–õ–£–®–ê–¢–ï–õ–ò ======
    document.getElementById('heapSelect')?.addEventListener('change', updateTakeOptions);
    document.getElementById('gameMode').addEventListener('change', () => {
      document.getElementById('aiLevel').closest('.setup-item').style.display = 
        document.getElementById('gameMode').value === 'ai' ? 'flex' : 'none';
    });
  </script>
</body>
</html>
